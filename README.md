# photo-reducer
スマホの写真やスクリーンショットのファイルサイズをスリム化するCLIです。自動監視モードあり。

## ドキュメント
- 設計書: `doc/design/photo-reducer-design.md` に機能・モード・`.photo-reducer` の振る舞いをまとめています。

## 使い方
1. `pnpm install` で依存を解決
2. `./bin/photo-reducer --source <元ディレクトリ> --output <出力ディレクトリ>` で実行

※ `bin/photo-reducer` はラッパーです。`dist/cli.js` が無い場合は自動で `pnpm run build` を実行してから起動します。

## オプション詳細
### 必須/排他
- **ディレクトリ処理（バッチ/監視）**: `--source` と `--output` が必須
- **単一ファイル処理**: `--file` と `--output` が必須（このモードでは `.photo-reducer` を更新しません）

### `--source <path>`
- **意味**: 入力ディレクトリ（再帰的に画像を探索）
- **対象**: ディレクトリ処理（バッチ/監視）のみ

### `--output <path>`
- **意味**: 出力ディレクトリ
- **挙動**: 存在しない場合は自動で作成します。サブディレクトリ構造も維持します。

### `--watch`
- **意味**: 監視モード（一定間隔でスキャンして新しいファイルのみ処理）
- **停止**: `Ctrl+C`
- **ログ**: 処理0件のサイクルはログ氾濫を避けるため、開始/0件完了ログを出しません（処理が発生した場合は出します）。

### `--interval <seconds>`（デフォルト: 60）
- **意味**: 監視モードのスキャン間隔（秒）
- **注意**: `--watch` を付けた時のみ有効

### `--since <since>`
- **意味**: 指定日時以降（更新日時が新しいもの）だけを処理
- **形式**:
  - `ISO 8601`（例: `2026-01-07T12:34:56+09:00`）
  - `YYYY-M-D`（例: `2026-1-7`）  
    この場合は **その日の 0:00 JST 以降**として解釈します。
- **優先順位**: `--from-now` > `--since` > `.photo-reducer.lastProcessedAt`

### `--from-now`
- **意味**: 今この瞬間を基準に開始（＝「今より新しいファイルだけ」を対象）
- **初回デフォルト**: `.photo-reducer` が無いディレクトリで初めて実行する場合、デフォルトで「今」を基準に `.photo-reducer` を作成します（処理0件でも基準固定のために作成します）。
- **注意**: 明示指定すると、既存 `.photo-reducer` があっても「今」を基準にできます。

### `--rate <number>`（デフォルト: 0.9）
- **意味**: 縮小率（0より大きく1以下）
- **挙動**: 画像の横幅/縦幅を `rate` 倍して出力します（例: 0.9 なら 90%）。

### `--max-output-width <px>`
- **意味**: 出力画像の最大横幅（ピクセル）
- **挙動**:
  - `--rate` で縮小した後の横幅が上限を超える場合、**横幅を上限に丸め**ます（縦横比は維持）。
  - `--rate 1` と組み合わせると「横幅だけ上限で抑える」用途にも使えます。

### `--png-format <png|webp|avif>`（デフォルト: png）
- **意味**: 入力がPNGのときの出力形式
- **挙動**:
  - `png` の場合: 拡張子は `.png` のまま
  - `webp` の場合: `.png` は `.webp` に変換して出力
  - `avif` の場合: `.png` は `.avif` に変換して出力
- **おすすめ**: スクリーンショットPNGは `webp` が小さくなりやすいです。

### `--file <path>`
- **意味**: 指定したファイル1件だけを処理（主にテスト用）
- **注意**: `.photo-reducer` は更新しません（監視/バッチ専用）。

### `-h, --help`
- **意味**: ヘルプを表示

## 重要な仕様（サイズ増大防止）
変換後のファイルサイズが元より大きくなった場合は、**その変換結果を採用せず、元ファイルをそのまま出力**します（「縮小したつもりで増える」を防ぐため）。
※ 形式変換（例: `--png-format webp`）を指定していても、増大する場合は元の拡張子のまま出力されます。

### 開発用
- `pnpm run dev -- --source <dir> --output <dir>` で ts-node 実行
- `pnpm run build` で `dist/cli.js` を生成

## 出力される `.photo-reducer`
監視・バッチモードでは、処理元ディレクトリごとに `.photo-reducer` が生成され、`lastProcessedAt` と `lastRate` を保持しています（単一ファイル処理では更新されません）。

## LaunchAgents（macOS）
ログイン時に監視モードを自動起動したい場合のサンプルは `doc/launchagents/` にあります（`com.user.photo-reducer-1.plist` / `com.user.photo-reducer-2.plist`）。
