#!/usr/bin/env bash
set -euo pipefail

# bin/photo-reducer はラッパーのみ（同一ロジックの複製を置かない）
# 実体は dist/cli.js を実行する。dist/cli.js が無ければ自動でビルドする。

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
CLI_JS="${PROJECT_ROOT}/dist/cli.js"

if ! command -v node >/dev/null 2>&1; then
  echo "エラー: node が見つかりません。Node.js をインストールしてください。" >&2
  exit 1
fi

if [[ ! -f "${CLI_JS}" ]]; then
  if ! command -v pnpm >/dev/null 2>&1; then
    echo "エラー: dist/cli.js が存在しません。pnpm が無いため自動ビルドできません。" >&2
    echo "ヒント: ${PROJECT_ROOT} で 'pnpm install' → 'pnpm run build' を実行してください。" >&2
    exit 1
  fi

  (
    cd "${PROJECT_ROOT}"
    pnpm -s run build
  )
fi

if [[ ! -f "${CLI_JS}" ]]; then
  echo "エラー: ビルド後も dist/cli.js が見つかりません。" >&2
  exit 1
fi

exec node "${CLI_JS}" "$@"
